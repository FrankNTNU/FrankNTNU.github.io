<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式組織圖</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f9fc;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        #chart_div {
            width: 100%;
            height: auto;
            max-width: 100%;
            /* Ensures it takes the full page width on the web */
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow-x: auto;
            /* Adds scrolling if the chart is too wide */
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .button-container {
            text-align: center;
            margin-bottom: 20px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #2980b9;
        }

        input[type="file"] {
            display: none;
        }

        @media print {
            .button-container {
                display: none;
            }

            #chart_div {
                width: 100%;
                height: auto;
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <h1>互動式組織圖</h1>
    <div class="button-container">
        <button onclick="printChart()">列印組織圖</button>
        <button onclick="document.getElementById('fileInput').click()">上傳資料</button>
        <input type="file" id="fileInput" accept=".xlsx" onchange="handleFileUpload(event)">
        <button onclick="downloadTemplate()">下載範本</button>
    </div>
    <div id="chart_div"></div>

    <script type="text/javascript">
        google.charts.load('current', { packages: ["orgchart"] });
        google.charts.setOnLoadCallback(drawChart);

        const levelColors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];

        let chartData = [
            [{ 'v': 'Mike', 'f': '<div style="background-color:#3498db; color:white; padding:5px; border-radius:5px;"><strong>Mike</strong><br/>執行長</div>' }, '', '首席執行官'],
            [{ 'v': 'Jim', 'f': '<div style="background-color:#2ecc71; color:white; padding:5px; border-radius:5px;"><strong>Jim</strong><br/>營運長</div>' }, 'Mike', '首席營運官'],
            [{ 'v': 'Alice', 'f': '<div style="background-color:#2ecc71; color:white; padding:5px; border-radius:5px;"><strong>Alice</strong><br/>財務長</div>' }, 'Mike', '首席財務官'],
            [{ 'v': 'Bob', 'f': '<div style="background-color:#2ecc71; color:white; padding:5px; border-radius:5px;"><strong>Bob</strong><br/>技術長</div>' }, 'Mike', '首席技術官'],
            [{ 'v': 'Carol', 'f': '<div style="background-color:#e74c3c; color:white; padding:5px; border-radius:5px;"><strong>Carol</strong><br/>人力資源總監</div>' }, 'Jim', '人力資源總監'],
            [{ 'v': 'David', 'f': '<div style="background-color:#e74c3c; color:white; padding:5px; border-radius:5px;"><strong>David</strong><br/>行銷總監</div>' }, 'Jim', '行銷總監'],
            [{ 'v': 'Eve', 'f': '<div style="background-color:#e74c3c; color:white; padding:5px; border-radius:5px;"><strong>Eve</strong><br/>財務控制師</div>' }, 'Alice', '財務控制師']
        ];

        let chart;
        let data;
        let options;
        function drawChart() {
            data = new google.visualization.DataTable();
            data.addColumn('string', 'Name');
            data.addColumn('string', 'Manager');
            data.addColumn('string', 'ToolTip');

            data.addRows(chartData);

            chart = new google.visualization.OrgChart(document.getElementById('chart_div'));

            options = {
                allowHtml: true,
                size: 'medium',
                nodeClass: 'node',
                selectedNodeClass: 'selected-node',
                color: '#fff',
                backgroundColor: 'transparent',
                compactRows: true,
            };
            chart.draw(data, options);
        }

        function printChart() {
            const chartDiv = document.getElementById('chart_div');
            // Select the whole table element
            const table = chartDiv.querySelector('.google-visualization-orgchart-table');
            // get table width
            // Clone the table to avoid modifying the original element
            const clone = table.cloneNode(true);
            document.body.appendChild(clone);

            // Get the dimensions of A4 landscape
            const a4WidthInMm = 297;  // A4 landscape width in mm
            // pixel to mm ratio
            const pixelToMm = 0.264583;
            // // Get the original table dimensions
            const tableWidth = clone.offsetWidth * pixelToMm  ;  // Width in pixels
            const tableHeight = clone.offsetHeight * pixelToMm;  // Height in pixels
            // // Calculate scaling factors to fit the table within the A4 dimensions
            const scaleX = a4WidthInMm / (tableWidth); // Convert pixels to mm (1 px = 0.264583 mm)

            console.log('a4WidthInMm', a4WidthInMm, 'tableWidth', tableWidth, 'tableHeight', tableHeight, 'scaleX', scaleX,);
            // // Apply scaling to the cloned element
            // clone.style.width = `${tableWidth * scaleX}px`;
            console.log(clone);

            // Create PDF options for html2pdf
            const opt = {
                margin: [10, 10],  // Set margins (top, left, bottom, right) in mm
                filename: 'org_chart.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, allowTaint: true },
                jsPDF: {
                    unit: 'mm', format: [
                        tableWidth + 50,
                        tableHeight + 50
                    ], orientation: 'landscape'
                },
                pagebreak: {
                    mode: ['avoid-all', 'css', 'legacy']
                },
            };

            // Generate the PDF from the resized clone
            html2pdf().from(clone).set(opt).save().then(() => {
                // Clean up by removing the clone after the PDF is generated
                document.body.removeChild(clone);
            });
        }



        function handleFileUpload(event) {
            const file = event.target.files[0];

            // Ensure the uploaded file is in .xlsx format
            if (!file || file.type !== "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") {
                alert("Please upload a valid Excel (.xlsx) file.");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assuming the data is in the first sheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];

                // Convert worksheet to JSON
                const results = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                chartData = results.slice(1).map((row) => {
                    const [name, role, manager, tooltip] = row;
                    const level = getLevel(manager, results.slice(1));
                    const color = levelColors[level % levelColors.length];
                    return [{
                        'v': name,
                        'f': `<div style="background-color:${color}; color:white; padding:5px; border-radius:5px; font-family: 'Microsoft JhengHei';"><strong>${name}</strong><br/>${role}</div>`
                    }, manager, tooltip];
                });

                drawChart();
            };

            reader.readAsArrayBuffer(file);
        }


        function getLevel(manager, data) {
            if (!manager) return 0;
            let level = 1;
            let currentManager = manager;
            while (currentManager) {
                const managerData = data.find(row => row[0] === currentManager);
                if (managerData) {
                    currentManager = managerData[2];
                    level++;
                } else {
                    break;
                }
            }
            return level;
        }

        function downloadTemplate() {
            // Define the data for the Excel file
            const data = [
                ["名稱", "職位", "主管", "Tooltip"],
                ["羅波特", "CEO", "", "首席執行官"],
                ["米雪兒", "COO", "羅波特", "首席營運官"],
                ["李明", "CTO", "羅波特", "首席技術官"],
                ["張華", "CFO", "羅波特", "首席財務官"],
                ["小林", "人力資源經理", "米雪兒", "負責招聘和培訓"],
                ["大衛", "行銷經理", "米雪兒", "負責市場推廣與品牌管理"],
                ["小美", "市場專員", "大衛", "負責社交媒體和廣告"],
                ["艾莉莎", "銷售經理", "大衛", "負責銷售團隊的管理"],
                ["凱莉", "業務代表", "艾莉莎", "負責客戶拜訪和需求收集"],
                ["施密特", "財務分析師", "張華", "負責財務報告與分析"],
                ["陳冠宇", "會計經理", "張華", "負責公司的會計事務"],
                ["錢小芳", "初級會計", "陳冠宇", "負責日常賬目處理"],
                ["方敏", "技術經理", "李明", "負責技術團隊的管理"],
                ["潔西卡", "產品經理", "李明", "負責產品策略與開發"],
                ["明莉", "開發經理", "方敏", "負責開發團隊的管理"],
                ["小紅", "前端開發人員", "明莉", "負責網站的前端開發"],
                ["小藍", "後端開發人員", "明莉", "負責網站的後端開發"],
                ["史密斯", "資訊安全專家", "李明", "負責公司的資訊安全"],
                ["小華", "IT支援專員", "史密斯", "負責技術支援與系統管理"],
                ["凱薩", "企業發展經理", "羅波特", "負責商業拓展和策略規劃"],
                ["羅莉", "公共關係經理", "凱薩", "負責公司與媒體的關係"],
                ["希拉", "社交媒體經理", "大衛", "負責社交媒體策略與執行"],
                ["阿東", "培訓專員", "小林", "負責員工培訓計畫"],
                ["小玲", "內部培訓講師", "阿東", "負責提供培訓課程"],
                ["大米", "客戶服務經理", "米雪兒", "負責客戶支持和滿意度"],
                ["喬安", "客戶支持專員", "大米", "負責解答客戶疑問"],
                ["小強", "數據科學家", "李明", "負責數據分析與報告"],
                ["小白", "資料分析專員", "小強", "負責數據清理與初步分析"],
                ["瑪莉", "品質保證經理", "潔西卡", "負責產品品質的監控"],
                ["小灰", "測試工程師", "瑪莉", "負責產品測試與缺陷報告"],
                ["澳里歐", "測試人員", "小紅", ""],
                ["貓傻立", "測試檢測人員", "澳里歐", ""],
                ["法蘭克", "監控人員", "貓傻立", ""],
                ["雄寶北", "監督", "法蘭克", ""]
            ];


            // Create a new workbook
            const workbook = XLSX.utils.book_new();

            // Convert the data array to a worksheet
            const worksheet = XLSX.utils.aoa_to_sheet(data);

            // Append the worksheet to the workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, "OrgChart");

            // Write the workbook to a file
            XLSX.writeFile(workbook, "org_chart_template.xlsx");
        }

    </script>
</body>

</html>
